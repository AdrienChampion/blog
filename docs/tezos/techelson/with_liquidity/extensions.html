<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Liquidity Extensions - Blog</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="navy">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="../../../welcome/index.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li><ol class="section"><li><a href="../../../welcome/latest.html"><strong aria-hidden="true">1.1.</strong> Latest</a></li><li><a href="../../../welcome/about.html"><strong aria-hidden="true">1.2.</strong> About Me</a></li></ol></li><li><a href="../../../tezos/index.html"><strong aria-hidden="true">2.</strong> Michelson/Liquidity</a></li><li><ol class="section"><li><a href="../../../tezos/techelson/with_liquidity/index.html"><strong aria-hidden="true">2.1.</strong> Using Techelson With Liquidity</a></li><li><ol class="section"><li><a href="../../../tezos/techelson/with_liquidity/extensions.html" class="active"><strong aria-hidden="true">2.1.1.</strong> Liquidity Extensions</a></li><li><a href="../../../tezos/techelson/with_liquidity/basic.html"><strong aria-hidden="true">2.1.2.</strong> Basic Example</a></li><li><a href="../../../tezos/techelson/with_liquidity/external.html"><strong aria-hidden="true">2.1.3.</strong> External Contract Example</a></li><li><a href="../../../tezos/techelson/with_liquidity/end.html"><strong aria-hidden="true">2.1.4.</strong> The End</a></li><li><a href="../../../tezos/techelson/with_liquidity/listing.html"><strong aria-hidden="true">2.1.5.</strong> File Listing</a></li></ol></li></ol></li><li><a href="../../../safety/index.html"><strong aria-hidden="true">3.</strong> Software Safety</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Blog</h1> 

                        <div class="right-buttons">
                            <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#liquidity-extensions" id="liquidity-extensions"><h2>Liquidity Extensions</h2></a>
<p>The first step is to declare the <a href="http://www.liquidity-lang.org/doc/reference/liquidity.html#extended-primitives" title="Liquidity's extensions">Liquidity extensions</a> we need. Let's create a <a href="listing.html#teststechelliq" title="Techelson extensions for liquidity">tests/techel.liq</a>
to write our extensions into:</p>
<pre><code class="language-ocaml">external get_balance :
    [%stack: address] -&gt; [%stack: tez]
    = &quot;GET_BALANCE&quot;
external get_storage :
    [%type: 'a] -&gt; [%stack: address] -&gt; [%stack: 'a option]
    = &quot;GET_STORAGE&quot;
external apply_operations :
    [%stack: operation list] -&gt; unit
    = &quot;APPLY_OPERATIONS&quot;
external start_set_source :
    [%stack: address] -&gt; unit
    = &quot;SET_SOURCE { #&quot;
external end_set_source :
    unit -&gt; unit
    = &quot;}&quot;
external must_fail :
    [%stack: operation] -&gt; [%stack: operation]
    = &quot;{ NONE string ; MUST_FAIL string }&quot;
</code></pre>
<p>It is not crucial to understand these rules precisely, only the power they give us. And that power
is the following functions. What they do precisely will become clear when we use them later on.</p>
<ul>
<li><code>get_balance address</code>: takes an address as parameter, and returns the balance of the contract at
that address</li>
<li><code>get_storage [%type: 'g] address</code>: takes a type and an address as parameter, and returns
<ul>
<li><code>Some</code> of the storage of the contract at that address, if it has type <code>'g</code></li>
<li><code>None</code> otherwise</li>
</ul>
</li>
<li><code>apply_operations ops</code>: takes a list of operations and applies them right away</li>
<li><code>start_set_source address</code> and <code>end_set_source ()</code>: a very, very dirty hack to define a <em>scope</em>
where all operations created appear to have been created by whatever is at <code>address</code></li>
<li><code>must_fail op</code>: tells techelson that the operation <code>op</code> must fail</li>
</ul>
<p>Thanks to Liquidity's file import mechanism, we can use these functions in any Liquidity file
<code>test.liq</code> with <code>Techel.get_balance</code>, <code>Techel.get_storage</code> <em>etc.</em> by simply calling Liquidity as
follows:</p>
<pre><code>$ liquidity tests/techel.liq test.liq
</code></pre>
<blockquote>
<p><strong>NB</strong>: you only need to write <code>tests/techel.liq</code> once, and make sure you pass it to Liquidity
when compiling your testcases, as in <code>test.sh</code> below.</p>
</blockquote>
<p>So let's fill in the <code>test.sh</code> file so that it runs our tests. It takes the path to our (future)
Liquidity test file(s) as argument, and compiles it/them along with all the contracts in
<code>contracts/</code> and the extensions we just defined. So, given some file <code>tests/test.liq</code>, the script</p>
<ul>
<li>generates <code>tests/test.liq.techel</code>: contains the testcase and the contract(s) to test, and</li>
<li>runs techelson on <code>tests/test.liq.techel</code>.</li>
</ul>
<pre><code class="language-bash">#! /bin/bash

set -e

test_file=&quot;$1&quot;

# List of all the contracts.
contracts=&quot;&quot;
for file in `find contracts -iname &quot;*.liq&quot;` ; do
    contracts=&quot;$contracts $file&quot;
done

# File liquidity will compile to.
target=&quot;$test_file.techel&quot;

echo &quot;Compiling $test_file...&quot;
echo
liquidity --no-annot --no-simplify --no-peephole tests/techel.liq$contracts -o $target $test_file
echo

# Running techelson on the target.
echo &quot;Running test $target&quot;
echo
techelson $target

</code></pre>
<blockquote>
<p><strong>Warning</strong>: function <code>start_set_source</code> uses a dirty hack so that it works as a Liquidity
extension (similar to a SQL injection). This is a temporary solution, eventually this hack will
not be necessary.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../../tezos/techelson/with_liquidity/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../../tezos/techelson/with_liquidity/basic.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../../../tezos/techelson/with_liquidity/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../../../tezos/techelson/with_liquidity/basic.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
